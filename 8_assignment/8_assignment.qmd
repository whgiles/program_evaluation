---
title: "Problem Set 8"
author: "W. Hunter Giles"
format: 
    pdf:
      code-line-numbers: true
      code-block-bg: true
    gfm: 
      toc: true
prefer-html: true
editor: visual
---

------------------------------------------------------------------------

```{r setup, warning=FALSE, message=FALSE}
library(tidyverse)     # For ggplot, mutate(), filter(), and friends
library(broom)         # For converting models to data frames
library(estimatr)      # For lm_robust() and iv_robust()
library(modelsummary)  # For showing side-by-side regression tables
library(MatchIt)       # For matching
library(rdrobust)      # For nonparametric RD
library(rddensity)     # For nonparametric RD density tests
library(haven)         # For reading Stata files

set.seed(1234)  # Make any random stuff be the same every time you run this

# Round everything to 3 digits by default
options("digits" = 3)

# Turn off the message that happens when you use group_by() and summarize()
options(dplyr.summarise.inform = FALSE)

# Load raw data
hisp_raw <- read_stata("../data/evaluation.dta")

# Make nice clean dataset to use for the rest of the assignment
hisp <- hisp_raw %>% 
  # Having a numeric 0/1 column is sometimes helpful for things that don't like
  # categories, like matchit()
  mutate(enrolled_num = enrolled) %>% 
  # Convert these 0/1 values to actual categories
  mutate(eligible = factor(eligible, labels = c("Not eligible", "Eligible")),
         enrolled = factor(enrolled, labels = c("Not enrolled", "Enrolled")),
         round = factor(round, labels = c("Before", "After")),
         treatment_locality = factor(treatment_locality, labels = c("Control", "Treatment")),
         promotion_locality = factor(promotion_locality, labels = c("No promotion", "Promotion"))) %>% 
  # Get rid of this hospital column because (1) we're not using it, and (2) half
  # of the households are missing data, and matchit() complains if any data is
  # missing, even if you're not using it
  select(-hospital)
```

The World Bank's *Impact Evaluation in Practice* has used a hypothetical example of a health insurance program throughout the book. This Health Insurance Subsidy Program (HISP) provides subsidies for buying private health insurance to poorer households, with the goal of lowering personal health expenditures, since people can rely on insurance coverage instead of paying out-of-pocket. Think of the HISP as a version of the Affordable Care Act (ACA, commonly known as Obamacare).

The dataset includes a number of important variables you'll use throughout this assignment:

| Variable name         | Description                                                      |
|-----------------------|-------------------------------------------------|
| `health_expenditures` | Out of pocket health expenditures (per person per year)          |
| `eligible`            | Household eligible to enroll in HISP                             |
| `enrolled`            | Household enrolled in HISP                                       |
| `round`               | Indicator for before and after intervention                      |
| `treatment_locality`  | Household is located in treatment community                      |
| `poverty_index`       | 1-100 scale of poverty                                           |
| `promotion_locality`  | Household is located in community that received random promotion |
| `enrolled_rp`         | Household enrolled in HISP following random promotion            |

It also includes several demographic variables about the households. **Each of these are backdoor confounders between health expenditures participation in the HISP**:

| Variable name       | Description                                               |
|-----------------------|-------------------------------------------------|
| `age_hh`            | Age of the head of household (years)                      |
| `age_sp`            | Age of the spouse (years)                                 |
| `educ_hh`           | Education of the head of household (years)                |
| `educ_sp`           | Education of the spouse (years)                           |
| `female_hh`         | Head of household is a woman (1 = yes)                    |
| `indigenous`        | Head of household speaks an indigenous language (1 = yes) |
| `hhsize`            | Number of household members                               |
| `dirtfloor`         | Home has a dirt floor (1 = yes)                           |
| `bathroom`          | Home has a private bathroom (1 = yes)                     |
| `land`              | Number of hectares of land owned by household             |
| `hospital_distance` | Distance to closest hospital (km)                         |

You will use each of the five main econometric approaches for estimating causal effects to measure the effect of HISP on household health expenditures. **Don't worry about conducting in-depth baseline checks and robustness checks.** For the sake of this assignment, you'll do the minimum amount of work for each method to determine the causal effect of the program.

# Task 1: RCTs

To measure the effect of HISP accurately, World Bank researchers randomly assigned different localities (villages, towns, cities, whatever) to treatment and control groups. Some localities were allowed to join HISP; others weren't.

Here's what you should do:

-   Make a new dataset that only looks at eligible households (`filter(eligible == "Eligible")`)
-   Make a new dataset that only looks at eligible households *after* the experiment (`filter(round == "After")`)
-   Calculate the average health expenditures in treatment and control localities (`treatment_locality`) *before* the intervention (`round == "Before"`). Were expenditures fairly balanced across treatment and control groups before the intervention?
-   Calculate the average health expenditures in treatment and control localities *after* the intervention (`round == "After"`)
-   Determine the difference in average health expenditures across treatment and control *after* the intervention
-   Using data *after* the intervention, use linear regression to determine the difference in means and statistical significance of the difference (hint: you'll want to use `health_expenditures ~ treatment_locality`). Use `lm_robust()` from the **estimatr** package and cluster by `locality_identifier` if you're feeling adventurous.
-   Create another model that controls for the following variables: `age_hh + age_sp + educ_hh + educ_sp + female_hh + indigenous + hhsize + dirtfloor + bathroom + land + hospital_distance`. (Use `lm_robust()` again if you're brave.) Does the estimate of the causal effect change?
-   Show the results from the two regressions in a side-by-side table if you want

```{r}
hisp_eligible <- hisp %>% 
  filter(eligible == "Eligible")

hisp_after <- hisp %>% 
  filter(round == "After")
```

Below are the average health expenditures for the treatment and control group before the intervention. The control group had an average expenditure of 17.4, and the the treatment group had an average expenditure of 17.0.

```{r}
hisp %>%
  filter(round == "Before") %>%
  group_by(treatment_locality) %>%
  summarize(mean = mean(health_expenditures))
```

After the intervention, the control group's average expenditure increases to 20.1 and the the treatment group's average expenditure decreases to 13.7.

```{r}
df <- hisp %>%
  filter(round == "After") %>%
  group_by(treatment_locality) %>%
  summarize(mean = mean(health_expenditures))
df
```

The treatment group has an average health expenditure that is 6.41 less than the control group after the intervention.

```{r}
diff(df$mean) # Control - Treatment
```

The linear regression shows that the treatment group's expenditure after the intervention is 6.41 less than the control group's.

```{r}
lm_model <- lm_robust(health_expenditures ~ treatment_locality, 
          data = hisp_after, 
          clusters = locality_identifier)
tidy(lm_model)
```

The confounders slightly biased the treatment effect away from zero. When controlling for confounders the treatment effect is 6.12, meaning the treatment group spends 6.12 less than the control group after the intervention.

```{r}
full_linear_model <- lm_robust(health_expenditures ~ treatment_locality + age_hh + age_sp + educ_hh + educ_sp + female_hh + indigenous + hhsize + dirtfloor + bathroom + land + hospital_distance, 
          data = hisp_after, 
          clusters = locality_identifier
          )
tidy(full_linear_model)
```

```{r}
modelsummary(list(
  "Simple Regression" = lm_model,
  "Multiple Regression" = full_linear_model 
))
```

# Task 2: Inverse probability weighting and/or matching

According to the model below, the people who enrolled in the intervention had 12.9 less in health expenditures compared to the non-enrollees. However, this is in inaccurate representation because it includes both compilers and always-takers.

```{r}
model.naive <- lm(health_expenditures ~ enrolled, 
              data = hisp_after)
tidy(model.naive)
```

***If you're using inverse probability weighting***, do the following:

-   Use logistic regression to model the probability of enrolling in the HISP. Hint: you'll need to use `glm()` (replace stuff in `<>` like `<THINGS>` with actual column names or dataset names). Also, note that this code below isn't in an actual R chunk, so don't try to run it.

``` r
model_logit <- glm(enrolled ~ COUNFOUNDER1 + COUNFOUNDER2 + ...,
                   data = NAME_OF_YOUR_AFTER_DATASET,
                   family = binomial(link = "logit"))
```

-   Generate propensity scores for enrollment in the HISP using something like this code (again, this isn't a chunk; don't try to run it):

``` r
enrolled_propensities <- augment_columns(MODEL_NAME, NAME_OF_YOUR_AFTER_DATASET, 
                                         type.predict = "response") %>% 
  rename(p_enrolled = .fitted)                                         
```

-   Add a new column to `enrolled_propensities` with `mutate()` that calculates the inverse probability weights using this formula (hint: "propensity" will be `p_enrolled`; "Treatment" will be `treatment_num`):

$$
\frac{\text{Treatment}}{\text{Propensity}} + \frac{1 - \text{Treatment}}{1 - \text{Propensity}}
$$

-   Run a model that estimates the effect of HISP enrollment on health expenditures (`health_expenditures ~ enrolled`) using the `enrolled_propensities` data, weighting by your new inverse probability weights column. What is the causal effect of HISP on health expenditures? How does this compare to the naive model? Which do you believe more? Why?
-   Show the results from the two regressions in a side-by-side table if you want

Logistic regression to model the probability of enrolling in the HISP.

```{r}
model_logit <- glm(enrolled ~ age_hh + age_sp + educ_hh + educ_sp + female_hh + indigenous + hhsize + dirtfloor + bathroom + land + hospital_distance,
                   data = hisp_after,
                   family = binomial(link = "logit"))
```

```{r}
enrolled_propensities <- augment_columns(model_logit, hisp_after, 
                                         type.predict = "response") %>% 
                                          rename(p_enrolled = .fitted)  

enrolled_propensities <- enrolled_propensities %>%
  mutate(inverse_prob = (enrolled_num/p_enrolled)+((1-enrolled_num)/(1-p_enrolled)))
```

```{r}
ipw_model <- lm(health_expenditures ~ enrolled, 
                         data = enrolled_propensities,
                         weights = inverse_prob)

tidy(ipw_model)
```

```{r}
modelsummary(list(
  "Naive" = model.naive,
  "IPW" = ipw_model
))
```
